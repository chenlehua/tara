# 汽车领域智能TARA分析系统架构设计

## 一、系统概述

### 1.1 系统定位
本系统是面向汽车行业的智能威胁分析与风险评估（TARA - Threat Analysis and Risk Assessment）平台，基于ISO/SAE 21434标准，结合AI智能体技术，实现汽车网络安全风险的自动化分析与评估。

### 1.2 核心能力
- **智能文档解析**：自动解析汽车架构文档、DBC文件、需求文档等
- **资产自动识别**：基于知识图谱的汽车资产自动发现与关联
- **威胁智能分析**：结合STRIDE/EVITA模型的智能威胁识别
- **风险量化评估**：基于Attack Potential的风险自动评估
- **报告自动生成**：一键生成符合ISO 21434的TARA报告

---

## 二、整体架构设计

### 2.1 架构总览

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              用户层 (User Layer)                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │   Web端     │  │   桌面端    │  │   移动端    │  │   API接口   │        │
│  │  (Vue3)     │  │ (Electron)  │  │  (UniApp)   │  │  (OpenAPI)  │        │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           网关层 (Gateway Layer)                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    Kong/Nginx API Gateway                            │   │
│  │      负载均衡 │ 认证授权 │ 限流熔断 │ 日志追踪 │ 协议转换            │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          业务服务层 (Service Layer)                          │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐         │
│  │ 项目管理 │ │ 文档解析 │ │ 资产识别 │ │ 威胁分析 │ │ 风险评估 │         │
│  │ Service  │ │ Service  │ │ Service  │ │ Service  │ │ Service  │         │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘         │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐         │
│  │ 图表生成 │ │ 报告中心 │ │ 用户权限 │ │ 审计日志 │ │ 通知服务 │         │
│  │ Service  │ │ Service  │ │ Service  │ │ Service  │ │ Service  │         │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘         │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         智能体层 (Agent Layer)                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      MCP Agent Orchestrator                          │   │
│  │   ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐   │   │
│  │   │ 文档理解    │ │ 资产挖掘    │ │ 威胁推理    │ │ 报告撰写    │   │   │
│  │   │ Agent       │ │ Agent       │ │ Agent       │ │ Agent       │   │   │
│  │   └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                      │                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        MCP Server Layer                              │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐  │   │
│  │  │Knowledge │ │ Database │ │ Document │ │ Analysis │ │  Report  │  │   │
│  │  │  Server  │ │  Server  │ │  Server  │ │  Server  │ │  Server  │  │   │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           AI模型层 (AI Model Layer)                          │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                    vLLM / Triton Inference Server                     │  │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────────┐ │  │
│  │  │  Qwen3-VL   │ │   Qwen3     │ │  OCRFlux    │ │ Qwen3-Embedding │ │  │
│  │  │    -8B     │ │   (LLM)     │ │   (OCR)     │ │     -0.6B       │ │  │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────────┘ │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           数据层 (Data Layer)                                │
│  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐    │
│  │   MySQL   │ │   Redis   │ │  Milvus   │ │   Neo4j   │ │   MinIO   │    │
│  │  业务数据  │ │ 缓存/会话 │ │ 向量存储  │ │ 知识图谱  │ │ 文件存储  │    │
│  └───────────┘ └───────────┘ └───────────┘ └───────────┘ └───────────┘    │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                        ElasticSearch                                   │ │
│  │              全文检索 │ 日志分析 │ 文档索引 │ 搜索引擎                  │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 三、分层架构详细设计

### 3.1 前端架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        前端架构 (Vue3 + TypeScript)               │
├─────────────────────────────────────────────────────────────────┤
│  Views                                                           │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐   │
│  │项目管理 │ │文档解析 │ │资产管理 │ │威胁分析 │ │风险评估 │   │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘   │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐                           │
│  │图表中心 │ │报告中心 │ │系统设置 │                           │
│  └─────────┘ └─────────┘ └─────────┘                           │
├─────────────────────────────────────────────────────────────────┤
│  Components                                                      │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐            │
│  │ 知识图谱可视化│ │ 攻击树编辑器 │ │ 风险矩阵组件 │            │
│  │ (D3.js/Cyto) │ │  (GoJS)      │ │ (ECharts)    │            │
│  └──────────────┘ └──────────────┘ └──────────────┘            │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐            │
│  │ 流程图编辑器 │ │ 文档预览器   │ │ AI对话组件   │            │
│  │ (LogicFlow)  │ │ (PDF/Office) │ │ (Stream)     │            │
│  └──────────────┘ └──────────────┘ └──────────────┘            │
├─────────────────────────────────────────────────────────────────┤
│  State Management: Pinia    │    Router: Vue Router 4          │
├─────────────────────────────────────────────────────────────────┤
│  HTTP Client: Axios    │    WebSocket: Socket.io-client        │
├─────────────────────────────────────────────────────────────────┤
│  UI Framework: Element Plus + TailwindCSS                       │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 后端微服务架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          后端微服务架构 (Python + FastAPI)                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        API Gateway (Kong)                            │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                      │                                      │
│           ┌──────────────────────────┼──────────────────────────┐          │
│           │                          │                          │          │
│           ▼                          ▼                          ▼          │
│  ┌─────────────────┐      ┌─────────────────┐      ┌─────────────────┐    │
│  │  tara-project   │      │  tara-document  │      │   tara-asset    │    │
│  │    Service      │      │    Service      │      │    Service      │    │
│  │                 │      │                 │      │                 │    │
│  │ • 项目CRUD      │      │ • 文档上传      │      │ • 资产CRUD      │    │
│  │ • 项目模板      │      │ • OCR识别       │      │ • 资产分类      │    │
│  │ • 权限管理      │      │ • 结构化解析    │      │ • 资产关联      │    │
│  │ • 版本控制      │      │ • 内容提取      │      │ • 损害场景      │    │
│  └─────────────────┘      └─────────────────┘      └─────────────────┘    │
│           │                          │                          │          │
│           ▼                          ▼                          ▼          │
│  ┌─────────────────┐      ┌─────────────────┐      ┌─────────────────┐    │
│  │  tara-threat    │      │   tara-risk     │      │  tara-report    │    │
│  │    Service      │      │    Service      │      │    Service      │    │
│  │                 │      │                 │      │                 │    │
│  │ • STRIDE分析    │      │ • 攻击可行性   │      │ • 报告模板      │    │
│  │ • 威胁场景      │      │ • 影响评级      │      │ • 报告生成      │    │
│  │ • 攻击路径      │      │ • 风险计算      │      │ • 导出功能      │    │
│  │ • 威胁库管理    │      │ • 处置建议      │      │ • 审批流程      │    │
│  └─────────────────┘      └─────────────────┘      └─────────────────┘    │
│           │                          │                          │          │
│           ▼                          ▼                          ▼          │
│  ┌─────────────────┐      ┌─────────────────┐      ┌─────────────────┐    │
│  │  tara-diagram   │      │  tara-common    │      │   tara-agent    │    │
│  │    Service      │      │    Service      │      │    Service      │    │
│  │                 │      │                 │      │                 │    │
│  │ • 攻击树生成    │      │ • 用户管理      │      │ • Agent编排     │    │
│  │ • 数据流图      │      │ • 认证授权      │      │ • MCP服务       │    │
│  │ • 架构图        │      │ • 字典管理      │      │ • 任务调度      │    │
│  │ • 风险矩阵      │      │ • 审计日志      │      │ • 工具注册      │    │
│  └─────────────────┘      └─────────────────┘      └─────────────────┘    │
│                                                                              │
├─────────────────────────────────────────────────────────────────────────────┤
│  消息队列: RabbitMQ/Kafka  │  服务注册: Nacos  │  配置中心: Nacos          │
├─────────────────────────────────────────────────────────────────────────────┤
│  分布式事务: Seata  │  链路追踪: Jaeger  │  监控: Prometheus + Grafana     │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 四、智能体架构设计

### 4.1 MCP智能体架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           MCP Agent Architecture                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      Agent Orchestrator (编排器)                      │   │
│  │  ┌─────────────────────────────────────────────────────────────┐    │   │
│  │  │                    Task Planner (任务规划)                    │    │   │
│  │  │  • 任务分解  • 依赖分析  • 执行策略  • 结果聚合              │    │   │
│  │  └─────────────────────────────────────────────────────────────┘    │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                      │                                      │
│       ┌──────────────────────────────┼──────────────────────────────┐      │
│       │              │               │               │              │      │
│       ▼              ▼               ▼               ▼              ▼      │
│  ┌─────────┐   ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐  │
│  │ 文档理解 │   │ 资产挖掘 │    │ 威胁推理 │    │ 风险评估 │    │ 报告撰写 │  │
│  │  Agent  │   │  Agent  │    │  Agent  │    │  Agent  │    │  Agent  │  │
│  │         │   │         │    │         │    │         │    │         │  │
│  │Qwen3-VL │   │ Qwen3 + │    │ Qwen3 + │    │ Qwen3 + │    │ Qwen3 + │  │
│  │+OCRFlux │   │ Neo4j   │    │ 规则引擎 │    │ 计算引擎 │    │ 模板引擎 │  │
│  └────┬────┘   └────┬────┘    └────┬────┘    └────┬────┘    └────┬────┘  │
│       │              │               │               │              │      │
│       └──────────────┴───────────────┴───────────────┴──────────────┘      │
│                                      │                                      │
│                                      ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        MCP Server Layer                              │   │
│  │                                                                       │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │   │
│  │  │  Knowledge  │  │   Database  │  │   Document  │  │  Inference  │ │   │
│  │  │   Server    │  │   Server    │  │   Server    │  │   Server    │ │   │
│  │  │             │  │             │  │             │  │             │ │   │
│  │  │ • 图谱查询  │  │ • SQL执行   │  │ • 文档读取  │  │ • 模型调用  │ │   │
│  │  │ • 知识检索  │  │ • 数据写入  │  │ • 内容提取  │  │ • 向量检索  │ │   │
│  │  │ • 关系推理  │  │ • 事务管理  │  │ • 格式转换  │  │ • 嵌入生成  │ │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘ │   │
│  │                                                                       │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │   │
│  │  │   Diagram   │  │   Report    │  │   Search    │  │   Notify    │ │   │
│  │  │   Server    │  │   Server    │  │   Server    │  │   Server    │ │   │
│  │  │             │  │             │  │             │  │             │ │   │
│  │  │ • 图表生成  │  │ • 报告渲染  │  │ • 全文检索  │  │ • 消息推送  │ │   │
│  │  │ • 布局计算  │  │ • 模板填充  │  │ • 聚合搜索  │  │ • 邮件通知  │ │   │
│  │  │ • 导出转换  │  │ • PDF导出   │  │ • 排序过滤  │  │ • 告警管理  │ │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘ │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 Agent 工作流设计

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          TARA分析智能体工作流                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                         Phase 1: 文档解析阶段                          │ │
│  │                                                                         │ │
│  │   ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐        │ │
│  │   │ 文档上传 │────▶│OCR识别  │────▶│版面分析 │────▶│内容提取 │        │ │
│  │   │(MinIO)  │     │(OCRFlux)│     │(Qwen3-VL)│     │(Qwen3)  │        │ │
│  │   └─────────┘     └─────────┘     └─────────┘     └─────────┘        │ │
│  │                                                          │            │ │
│  │                                                          ▼            │ │
│  │                                                   ┌─────────────┐     │ │
│  │                                                   │ 结构化存储   │     │ │
│  │                                                   │(ES + MySQL) │     │ │
│  │                                                   └─────────────┘     │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                       │                                     │
│                                       ▼                                     │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                         Phase 2: 资产识别阶段                          │ │
│  │                                                                         │ │
│  │   ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐        │ │
│  │   │实体抽取 │────▶│资产分类 │────▶│关系识别 │────▶│图谱构建 │        │ │
│  │   │(Qwen3)  │     │(分类器) │     │(Qwen3)  │     │(Neo4j)  │        │ │
│  │   └─────────┘     └─────────┘     └─────────┘     └─────────┘        │ │
│  │                                                          │            │ │
│  │                                                          ▼            │ │
│  │   ┌─────────────────────────────────────────────────────────────┐    │ │
│  │   │                      汽车资产知识图谱                         │    │ │
│  │   │  ECU ──────┐                                                │    │ │
│  │   │            ├──▶ CAN总线 ──▶ 传感器/执行器                   │    │ │
│  │   │  Gateway ──┘                                                │    │ │
│  │   │            ┌──▶ 以太网 ──▶ 域控制器                         │    │ │
│  │   │  TBOX ─────┤                                                │    │ │
│  │   │            └──▶ 云服务 ──▶ OTA/远程控制                     │    │ │
│  │   └─────────────────────────────────────────────────────────────┘    │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                       │                                     │
│                                       ▼                                     │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                         Phase 3: 威胁分析阶段                          │ │
│  │                                                                         │ │
│  │   ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐        │ │
│  │   │损害场景 │────▶│威胁场景 │────▶│攻击路径 │────▶│攻击树   │        │ │
│  │   │识别     │     │STRIDE   │     │分析     │     │构建     │        │ │
│  │   └─────────┘     └─────────┘     └─────────┘     └─────────┘        │ │
│  │                                                                         │ │
│  │   STRIDE模型:                                                          │ │
│  │   • Spoofing (欺骗)           • Tampering (篡改)                       │ │
│  │   • Repudiation (抵赖)        • Information Disclosure (信息泄露)      │ │
│  │   • Denial of Service (拒绝服务)  • Elevation of Privilege (权限提升) │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                       │                                     │
│                                       ▼                                     │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                         Phase 4: 风险评估阶段                          │ │
│  │                                                                         │ │
│  │   ┌─────────────────────────────────────────────────────────────┐     │ │
│  │   │                    Attack Potential 评估                     │     │ │
│  │   │                                                               │     │ │
│  │   │   攻击可行性 = f(专业知识, 攻击时间, 设备条件, 信息获取)      │     │ │
│  │   │                                                               │     │ │
│  │   │   ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐    │     │ │
│  │   │   │专业知识  │  │攻击时间  │  │设备条件  │  │信息获取  │    │     │ │
│  │   │   │ 0-8分   │  │ 0-19分  │  │ 0-10分  │  │ 0-7分   │    │     │ │
│  │   │   └──────────┘  └──────────┘  └──────────┘  └──────────┘    │     │ │
│  │   └─────────────────────────────────────────────────────────────┘     │ │
│  │                                                                         │ │
│  │   ┌─────────────────────────────────────────────────────────────┐     │ │
│  │   │                    Impact 影响评估                           │     │ │
│  │   │                                                               │     │ │
│  │   │   ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐    │     │ │
│  │   │   │安全影响  │  │财务影响  │  │运营影响  │  │隐私影响  │    │     │ │
│  │   │   │S0-S3    │  │F0-F3    │  │O0-O3    │  │P0-P3    │    │     │ │
│  │   │   └──────────┘  └──────────┘  └──────────┘  └──────────┘    │     │ │
│  │   └─────────────────────────────────────────────────────────────┘     │ │
│  │                                                                         │ │
│  │   Risk = Impact × Likelihood                                           │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                       │                                     │
│                                       ▼                                     │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                         Phase 5: 报告生成阶段                          │ │
│  │                                                                         │ │
│  │   ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐        │ │
│  │   │数据聚合 │────▶│报告撰写 │────▶│图表生成 │────▶│PDF导出  │        │ │
│  │   │         │     │(Qwen3)  │     │         │     │         │        │ │
│  │   └─────────┘     └─────────┘     └─────────┘     └─────────┘        │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 五、数据架构设计

### 5.1 多源异构数据存储架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            数据存储架构                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                          MySQL (业务主数据)                          │   │
│  │                                                                       │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐            │   │
│  │  │ 项目表   │  │ 资产表   │  │ 威胁表   │  │ 风险表   │            │   │
│  │  │project   │  │ asset    │  │ threat   │  │  risk    │            │   │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘            │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐            │   │
│  │  │ 报告表   │  │ 用户表   │  │ 权限表   │  │ 字典表   │            │   │
│  │  │ report   │  │  user    │  │permission│  │  dict    │            │   │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘            │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        Neo4j (知识图谱)                              │   │
│  │                                                                       │   │
│  │  节点类型:                                                            │   │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐   │   │
│  │  │  Asset  │  │ Threat  │  │  Attack │  │ Vulner  │  │Control  │   │   │
│  │  │  资产   │  │  威胁   │  │攻击路径 │  │  漏洞   │  │安全措施 │   │   │
│  │  └─────────┘  └─────────┘  └─────────┘  └─────────┘  └─────────┘   │   │
│  │                                                                       │   │
│  │  关系类型:                                                            │   │
│  │  • CONNECTS_TO (连接)      • THREATENS (威胁)                        │   │
│  │  • EXPLOITS (利用)         • MITIGATES (缓解)                        │   │
│  │  • CONTAINS (包含)         • DEPENDS_ON (依赖)                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        Milvus (向量数据库)                           │   │
│  │                                                                       │   │
│  │  Collections:                                                         │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐               │   │
│  │  │doc_embedding │  │threat_embed  │  │control_embed │               │   │
│  │  │ 文档向量库   │  │ 威胁库向量   │  │ 控制措施向量 │               │   │
│  │  │ dim: 1024    │  │ dim: 1024    │  │ dim: 1024    │               │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘               │   │
│  │                                                                       │   │
│  │  用途: 语义检索、相似威胁匹配、知识库问答                            │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      ElasticSearch (搜索引擎)                        │   │
│  │                                                                       │   │
│  │  Indices:                                                             │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐               │   │
│  │  │tara_document │  │ tara_threat  │  │  tara_log    │               │   │
│  │  │ 文档全文索引 │  │ 威胁库索引   │  │  操作日志    │               │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘               │   │
│  │                                                                       │   │
│  │  用途: 全文检索、日志分析、聚合统计                                  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         Redis (缓存层)                               │   │
│  │                                                                       │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐               │   │
│  │  │ Session      │  │ Cache        │  │ Queue        │               │   │
│  │  │ 用户会话     │  │ 数据缓存     │  │ 任务队列     │               │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘               │   │
│  │                                                                       │   │
│  │  用途: 会话管理、热点数据缓存、分布式锁、任务队列                    │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         MinIO (对象存储)                             │   │
│  │                                                                       │   │
│  │  Buckets:                                                             │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐               │   │
│  │  │  documents   │  │   reports    │  │   diagrams   │               │   │
│  │  │ 原始文档     │  │ 分析报告     │  │ 生成的图表   │               │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘               │   │
│  │                                                                       │   │
│  │  用途: 文件存储、版本管理、大文件处理                                │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 核心数据模型

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              核心数据模型                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                           项目 (Project)                             │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │  id              │ bigint       │ 主键                               │   │
│  │  name            │ varchar(200) │ 项目名称                           │   │
│  │  description     │ text         │ 项目描述                           │   │
│  │  vehicle_type    │ varchar(50)  │ 车型类型                           │   │
│  │  standard        │ varchar(50)  │ 参考标准 (ISO21434/UNECE)          │   │
│  │  status          │ tinyint      │ 状态                               │   │
│  │  owner_id        │ bigint       │ 项目负责人                          │   │
│  │  created_at      │ datetime     │ 创建时间                           │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                      │                                      │
│                          1:N         │                                      │
│                                      ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                           资产 (Asset)                               │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │  id              │ bigint       │ 主键                               │   │
│  │  project_id      │ bigint       │ 所属项目                           │   │
│  │  name            │ varchar(200) │ 资产名称                           │   │
│  │  type            │ varchar(50)  │ 类型(ECU/Gateway/Sensor等)         │   │
│  │  category        │ varchar(50)  │ 分类(硬件/软件/数据/服务)          │   │
│  │  description     │ text         │ 描述                               │   │
│  │  security_attrs  │ json         │ 安全属性(CIA)                      │   │
│  │  interfaces      │ json         │ 接口信息                           │   │
│  │  parent_id       │ bigint       │ 父资产ID                           │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                      │                                      │
│                          1:N         │                                      │
│                                      ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        损害场景 (DamageScenario)                      │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │  id              │ bigint       │ 主键                               │   │
│  │  asset_id        │ bigint       │ 关联资产                           │   │
│  │  name            │ varchar(200) │ 场景名称                           │   │
│  │  description     │ text         │ 场景描述                           │   │
│  │  safety_impact   │ tinyint      │ 安全影响 S0-S3                     │   │
│  │  financial_impact│ tinyint      │ 财务影响 F0-F3                     │   │
│  │  operational_imp │ tinyint      │ 运营影响 O0-O3                     │   │
│  │  privacy_impact  │ tinyint      │ 隐私影响 P0-P3                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                      │                                      │
│                          1:N         │                                      │
│                                      ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        威胁场景 (ThreatScenario)                      │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │  id              │ bigint       │ 主键                               │   │
│  │  damage_id       │ bigint       │ 关联损害场景                        │   │
│  │  name            │ varchar(200) │ 威胁名称                           │   │
│  │  threat_type     │ varchar(20)  │ STRIDE类型                         │   │
│  │  attack_vector   │ text         │ 攻击向量                           │   │
│  │  prerequisites   │ text         │ 前置条件                           │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                      │                                      │
│                          1:N         │                                      │
│                                      ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        攻击路径 (AttackPath)                         │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │  id              │ bigint       │ 主键                               │   │
│  │  threat_id       │ bigint       │ 关联威胁场景                        │   │
│  │  name            │ varchar(200) │ 攻击路径名称                        │   │
│  │  steps           │ json         │ 攻击步骤                           │   │
│  │  expertise       │ tinyint      │ 专业知识 0-8                       │   │
│  │  elapsed_time    │ tinyint      │ 攻击时间 0-19                      │   │
│  │  equipment       │ tinyint      │ 设备条件 0-10                      │   │
│  │  knowledge       │ tinyint      │ 信息获取 0-7                       │   │
│  │  attack_potential│ tinyint      │ 攻击可行性得分                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                      │                                      │
│                          N:1         │                                      │
│                                      ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        风险评估 (RiskAssessment)                      │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │  id              │ bigint       │ 主键                               │   │
│  │  attack_path_id  │ bigint       │ 关联攻击路径                        │   │
│  │  impact_level    │ tinyint      │ 影响等级 1-4                       │   │
│  │  likelihood      │ tinyint      │ 可能性 1-5                         │   │
│  │  risk_value      │ tinyint      │ 风险值 1-5                         │   │
│  │  risk_level      │ varchar(20)  │ 风险等级                           │   │
│  │  treatment       │ varchar(50)  │ 处置策略                           │   │
│  │  controls        │ json         │ 控制措施                           │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 六、AI模型服务架构

### 6.1 模型部署架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           AI模型服务架构                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    Model Gateway (模型网关)                          │   │
│  │  ┌─────────────────────────────────────────────────────────────┐    │   │
│  │  │  负载均衡 │ 请求路由 │ 限流控制 │ 模型版本管理 │ 监控告警    │    │   │
│  │  └─────────────────────────────────────────────────────────────┘    │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                      │                                      │
│       ┌──────────────────────────────┼──────────────────────────────┐      │
│       │                              │                              │      │
│       ▼                              ▼                              ▼      │
│  ┌─────────────────┐      ┌─────────────────┐      ┌─────────────────┐    │
│  │   vLLM Server   │      │   vLLM Server   │      │  Triton Server  │    │
│  │   (Qwen3-VL)    │      │    (Qwen3)      │      │   (OCRFlux)     │    │
│  │                 │      │                 │      │                 │    │
│  │ • 多模态理解    │      │ • 文本生成      │      │ • OCR识别       │    │
│  │ • 图像分析      │      │ • 推理分析      │      │ • 表格识别      │    │
│  │ • 文档理解      │      │ • 代码生成      │      │ • 公式识别      │    │
│  │                 │      │                 │      │                 │    │
│  │ GPU: A100 40GB  │      │ GPU: A100 40GB  │      │ GPU: A10 24GB   │    │
│  │ Replicas: 2     │      │ Replicas: 2     │      │ Replicas: 1     │    │
│  └─────────────────┘      └─────────────────┘      └─────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    Embedding Service (向量服务)                       │   │
│  │  ┌─────────────────────────────────────────────────────────────┐    │   │
│  │  │              Qwen3-Embedding-0.6B (Text Embedding)           │    │   │
│  │  │                                                               │    │   │
│  │  │  • 文档向量化        • 查询向量化        • 批量嵌入           │    │   │
│  │  │  • Dimension: 1024   • Max Tokens: 8192  • GPU: T4 16GB      │    │   │
│  │  └─────────────────────────────────────────────────────────────┘    │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      Model Pipeline (处理流水线)                      │   │
│  │                                                                       │   │
│  │  ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐          │   │
│  │  │   预    │───▶│   模    │───▶│   后    │───▶│   结    │          │   │
│  │  │   处    │    │   型    │    │   处    │    │   果    │          │   │
│  │  │   理    │    │   推    │    │   理    │    │   缓    │          │   │
│  │  │         │    │   理    │    │         │    │   存    │          │   │
│  │  └─────────┘    └─────────┘    └─────────┘    └─────────┘          │   │
│  │  • 分词        • 推理计算     • 结果解析     • Redis缓存           │   │
│  │  • 归一化      • 采样策略     • 格式转换     • 异步回调            │   │
│  │  • 截断        • Beam Search  • 校验过滤                           │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 6.2 模型能力矩阵

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                             模型能力矩阵                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────┬───────────────────────────────────────────────────────┐   │
│  │   模型      │                      能力与应用场景                     │   │
│  ├─────────────┼───────────────────────────────────────────────────────┤   │
│  │             │ • 架构图理解与解析                                     │   │
│  │ Qwen3-VL-8B │ • 数据流图分析                                        │   │
│  │             │ • 文档版面分析                                         │   │
│  │ (视觉语言)   │ • 表格图像识别                                        │   │
│  │             │ • 图片内容理解                                         │   │
│  ├─────────────┼───────────────────────────────────────────────────────┤   │
│  │             │ • 威胁场景生成与推理                                   │   │
│  │   Qwen3     │ • 风险评估分析                                        │   │
│  │             │ • 报告内容撰写                                         │   │
│  │ (大语言模型) │ • 攻击路径分析                                        │   │
│  │             │ • 对话问答与解释                                       │   │
│  │             │ • 实体关系抽取                                         │   │
│  ├─────────────┼───────────────────────────────────────────────────────┤   │
│  │             │ • PDF文档OCR                                          │   │
│  │  OCRFlux    │ • 扫描件识别                                          │   │
│  │             │ • 表格结构识别                                         │   │
│  │ (OCR模型)   │ • 公式识别                                            │   │
│  │             │ • 手写内容识别                                         │   │
│  ├─────────────┼───────────────────────────────────────────────────────┤   │
│  │ Qwen3-     │ • 文档向量化                                           │   │
│  │ Embedding   │ • 语义相似度计算                                       │   │
│  │             │ • 威胁库检索                                           │   │
│  │ (嵌入模型)   │ • 知识库问答                                          │   │
│  │             │ • 聚类分析                                             │   │
│  └─────────────┴───────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 七、部署架构设计

### 7.1 Kubernetes部署架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          Kubernetes 部署架构                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         Ingress Controller                           │   │
│  │                    (Nginx Ingress / Traefik)                         │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                      │                                      │
│       ┌──────────────────────────────┼──────────────────────────────┐      │
│       │                              │                              │      │
│       ▼                              ▼                              ▼      │
│  ┌─────────────────┐      ┌─────────────────┐      ┌─────────────────┐    │
│  │   tara-web      │      │   tara-api      │      │  tara-agent     │    │
│  │   Namespace     │      │   Namespace     │      │   Namespace     │    │
│  │                 │      │                 │      │                 │    │
│  │ ┌─────────────┐│      │ ┌─────────────┐ │      │ ┌─────────────┐ │    │
│  │ │ frontend    ││      │ │ project-svc │ │      │ │ orchestrator│ │    │
│  │ │ Deployment  ││      │ │ Deployment  │ │      │ │ Deployment  │ │    │
│  │ │ replicas: 3 ││      │ │ replicas: 3 │ │      │ │ replicas: 2 │ │    │
│  │ └─────────────┘│      │ └─────────────┘ │      │ └─────────────┘ │    │
│  │                │      │ ┌─────────────┐ │      │ ┌─────────────┐ │    │
│  │                │      │ │ document-svc│ │      │ │ mcp-servers │ │    │
│  │                │      │ │ Deployment  │ │      │ │ StatefulSet │ │    │
│  │                │      │ │ replicas: 3 │ │      │ │ replicas: 3 │ │    │
│  │                │      │ └─────────────┘ │      │ └─────────────┘ │    │
│  │                │      │      ...        │      │                 │    │
│  └─────────────────┘      └─────────────────┘      └─────────────────┘    │
│                                                                              │
│  ┌─────────────────┐      ┌─────────────────┐      ┌─────────────────┐    │
│  │   tara-model    │      │   tara-data     │      │   tara-infra    │    │
│  │   Namespace     │      │   Namespace     │      │   Namespace     │    │
│  │                 │      │                 │      │                 │    │
│  │ ┌─────────────┐│      │ ┌─────────────┐ │      │ ┌─────────────┐ │    │
│  │ │ vllm-qwen3  ││      │ │ mysql       │ │      │ │ prometheus  │ │    │
│  │ │ Deployment  ││      │ │ StatefulSet │ │      │ │ Deployment  │ │    │
│  │ │ GPU: 2xA100 ││      │ │ replicas: 3 │ │      │ │ replicas: 1 │ │    │
│  │ └─────────────┘│      │ └─────────────┘ │      │ └─────────────┘ │    │
│  │ ┌─────────────┐│      │ ┌─────────────┐ │      │ ┌─────────────┐ │    │
│  │ │ vllm-vl     ││      │ │ redis       │ │      │ │ grafana     │ │    │
│  │ │ Deployment  ││      │ │ StatefulSet │ │      │ │ Deployment  │ │    │
│  │ │ GPU: 2xA100 ││      │ │ replicas: 3 │ │      │ │ replicas: 1 │ │    │
│  │ └─────────────┘│      │ └─────────────┘ │      │ └─────────────┘ │    │
│  │ ┌─────────────┐│      │ ┌─────────────┐ │      │ ┌─────────────┐ │    │
│  │ │ embedding   ││      │ │ milvus      │ │      │ │ jaeger      │ │    │
│  │ │ Deployment  ││      │ │ StatefulSet │ │      │ │ Deployment  │ │    │
│  │ │ GPU: 1xT4   ││      │ │ replicas: 3 │ │      │ │ replicas: 1 │ │    │
│  │ └─────────────┘│      │ └─────────────┘ │      │ └─────────────┘ │    │
│  │ ┌─────────────┐│      │ ┌─────────────┐ │      │                 │    │
│  │ │ ocrflux     ││      │ │ elasticsearch│ │      │                 │    │
│  │ │ Deployment  ││      │ │ StatefulSet │ │      │                 │    │
│  │ │ GPU: 1xA10  ││      │ │ replicas: 3 │ │      │                 │    │
│  │ └─────────────┘│      │ └─────────────┘ │      │                 │    │
│  │                │      │ ┌─────────────┐ │      │                 │    │
│  │                │      │ │ neo4j       │ │      │                 │    │
│  │                │      │ │ StatefulSet │ │      │                 │    │
│  │                │      │ │ replicas: 3 │ │      │                 │    │
│  │                │      │ └─────────────┘ │      │                 │    │
│  │                │      │ ┌─────────────┐ │      │                 │    │
│  │                │      │ │ minio       │ │      │                 │    │
│  │                │      │ │ StatefulSet │ │      │                 │    │
│  │                │      │ │ replicas: 4 │ │      │                 │    │
│  │                │      │ └─────────────┘ │      │                 │    │
│  └─────────────────┘      └─────────────────┘      └─────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        Storage Classes                               │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                  │   │
│  │  │ local-ssd   │  │  nfs-client │  │ ceph-block  │                  │   │
│  │  │ (高性能)    │  │ (共享存储)  │  │ (分布式)    │                  │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘                  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 7.2 硬件资源规划

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            硬件资源规划 (生产环境)                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                          GPU服务器 (AI推理)                          │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │  节点类型        │ 数量 │ 配置                                       │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │  AI推理节点      │  3   │ • CPU: 64核 AMD EPYC                       │   │
│  │  (高性能)        │      │ • 内存: 512GB DDR5                         │   │
│  │                  │      │ • GPU: 4x NVIDIA A100 80GB                 │   │
│  │                  │      │ • 存储: 2TB NVMe SSD                       │   │
│  │                  │      │ • 网络: 100Gbps RDMA                       │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │  Embedding节点   │  2   │ • CPU: 32核 Intel Xeon                     │   │
│  │  (向量计算)      │      │ • 内存: 128GB DDR5                         │   │
│  │                  │      │ • GPU: 2x NVIDIA T4 16GB                   │   │
│  │                  │      │ • 存储: 1TB NVMe SSD                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         通用计算服务器                               │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │  节点类型        │ 数量 │ 配置                                       │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │  K8s Master      │  3   │ • CPU: 16核                                │   │
│  │                  │      │ • 内存: 64GB                               │   │
│  │                  │      │ • 存储: 500GB SSD                          │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │  K8s Worker      │  6   │ • CPU: 32核                                │   │
│  │  (业务服务)      │      │ • 内存: 128GB                              │   │
│  │                  │      │ • 存储: 1TB SSD                            │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │  数据库节点      │  3   │ • CPU: 32核                                │   │
│  │  (MySQL/Neo4j)   │      │ • 内存: 256GB                              │   │
│  │                  │      │ • 存储: 4TB NVMe SSD (RAID10)              │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │  搜索/向量节点   │  3   │ • CPU: 32核                                │   │
│  │  (ES/Milvus)     │      │ • 内存: 256GB                              │   │
│  │                  │      │ • 存储: 4TB NVMe SSD                       │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │  存储节点        │  4   │ • CPU: 16核                                │   │
│  │  (MinIO)         │      │ • 内存: 64GB                               │   │
│  │                  │      │ • 存储: 20TB HDD (JBOD)                    │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                          资源汇总                                    │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │  • 服务器总数: 24台                                                  │   │
│  │  • CPU总核数: ~700核                                                 │   │
│  │  • 内存总量: ~4TB                                                    │   │
│  │  • GPU显存: ~1TB (12x A100 80GB + 4x T4 16GB)                        │   │
│  │  • 存储容量: ~100TB                                                  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 八、安全架构设计

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              安全架构设计                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        网络安全层                                    │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐            │   │
│  │  │ 防火墙   │  │ WAF      │  │ DDoS防护 │  │ VPN接入  │            │   │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘            │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        应用安全层                                    │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐            │   │
│  │  │ JWT认证  │  │ RBAC权限 │  │ API限流  │  │ 输入校验 │            │   │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘            │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐            │   │
│  │  │ HTTPS    │  │ 敏感脱敏 │  │ SQL防注入 │  │ XSS防护  │            │   │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘            │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        数据安全层                                    │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐            │   │
│  │  │ 数据加密 │  │ 密钥管理 │  │ 备份恢复 │  │ 审计日志 │            │   │
│  │  │ (AES-256)│  │ (Vault)  │  │          │  │          │            │   │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘            │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        合规安全                                      │   │
│  │  • 符合ISO 21434汽车网络安全标准                                     │   │
│  │  • 符合GDPR数据保护要求                                              │   │
│  │  • 支持等保2.0三级要求                                               │   │
│  │  • 定期安全审计与渗透测试                                            │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 九、关键技术实现要点

### 9.1 MCP Server 实现示例

```python
# MCP Knowledge Server 示例实现
from mcp import Server, Tool, Resource
from neo4j import GraphDatabase

class KnowledgeServer(Server):
    def __init__(self):
        super().__init__("knowledge-server")
        self.neo4j_driver = GraphDatabase.driver(...)
        
    @Tool(
        name="query_knowledge_graph",
        description="查询汽车安全知识图谱"
    )
    async def query_knowledge_graph(
        self, 
        query_type: str,  # asset/threat/attack_path
        entity_id: str = None,
        filters: dict = None
    ) -> dict:
        """查询知识图谱中的资产、威胁、攻击路径关系"""
        cypher = self._build_cypher(query_type, entity_id, filters)
        with self.neo4j_driver.session() as session:
            result = session.run(cypher)
            return self._format_result(result)
    
    @Tool(
        name="find_related_threats",
        description="基于资产查找相关威胁"
    )
    async def find_related_threats(
        self,
        asset_id: str,
        depth: int = 2
    ) -> list:
        """查找与指定资产相关的威胁场景"""
        cypher = f"""
        MATCH (a:Asset {{id: '{asset_id}'}})-[:THREATENS*1..{depth}]-(t:Threat)
        RETURN t, relationships(path) as rels
        """
        # ...实现逻辑
        
    @Resource(
        uri="knowledge://threat-library",
        description="威胁库资源"
    )
    async def get_threat_library(self) -> dict:
        """获取标准威胁库"""
        # 返回STRIDE分类的威胁模板
        pass
```

### 9.2 Agent 编排示例

```python
# TARA分析Agent编排器
from langchain.agents import AgentExecutor
from langchain_core.prompts import ChatPromptTemplate

class TARAOrchestrator:
    def __init__(self):
        self.document_agent = DocumentUnderstandingAgent()
        self.asset_agent = AssetDiscoveryAgent()
        self.threat_agent = ThreatAnalysisAgent()
        self.risk_agent = RiskAssessmentAgent()
        self.report_agent = ReportGenerationAgent()
        
    async def execute_tara_analysis(
        self, 
        project_id: str,
        documents: list
    ) -> TARAResult:
        """执行完整的TARA分析流程"""
        
        # Phase 1: 文档解析
        doc_results = await self.document_agent.process(documents)
        
        # Phase 2: 资产识别
        assets = await self.asset_agent.discover(
            doc_results,
            knowledge_base=self.knowledge_server
        )
        
        # Phase 3: 威胁分析
        threats = await self.threat_agent.analyze(
            assets,
            methodology="STRIDE"
        )
        
        # Phase 4: 风险评估
        risks = await self.risk_agent.assess(
            threats,
            method="attack_potential"
        )
        
        # Phase 5: 报告生成
        report = await self.report_agent.generate(
            project_id=project_id,
            assets=assets,
            threats=threats,
            risks=risks,
            template="ISO21434"
        )
        
        return TARAResult(
            assets=assets,
            threats=threats,
            risks=risks,
            report=report
        )
```

---

## 十、项目里程碑规划

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              项目里程碑规划                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Phase 1: 基础设施搭建 (Month 1-2)                                          │
│  ├── K8s集群部署                                                            │
│  ├── 数据库集群搭建 (MySQL/Redis/Neo4j/Milvus/ES/MinIO)                    │
│  ├── AI模型部署 (vLLM/Triton)                                              │
│  └── CI/CD流水线搭建                                                        │
│                                                                              │
│  Phase 2: 核心功能开发 (Month 3-5)                                          │
│  ├── 项目管理模块                                                           │
│  ├── 文档解析服务 (OCR + 多模态理解)                                        │
│  ├── 资产识别服务                                                           │
│  ├── 知识图谱构建                                                           │
│  └── MCP Server开发                                                         │
│                                                                              │
│  Phase 3: 智能分析开发 (Month 6-8)                                          │
│  ├── 威胁分析Agent                                                          │
│  ├── 风险评估引擎                                                           │
│  ├── Agent编排系统                                                          │
│  └── 攻击树/图表生成                                                        │
│                                                                              │
│  Phase 4: 报告与优化 (Month 9-10)                                           │
│  ├── 报告生成模块                                                           │
│  ├── 前端界面完善                                                           │
│  ├── 性能优化                                                               │
│  └── 安全加固                                                               │
│                                                                              │
│  Phase 5: 测试与上线 (Month 11-12)                                          │
│  ├── 集成测试                                                               │
│  ├── 用户验收测试                                                           │
│  ├── 生产环境部署                                                           │
│  └── 运维文档编写                                                           │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 十一、总结

本架构设计方案针对汽车领域智能TARA分析系统，采用了以下核心设计理念:

1. **微服务架构**: 业务模块解耦，独立部署，便于扩展维护
2. **智能体驱动**: 基于MCP协议的Agent系统，实现AI能力的灵活编排
3. **多模态AI**: 结合视觉、语言、OCR等多种AI能力，实现文档全面理解
4. **知识图谱增强**: Neo4j存储汽车安全知识，支持复杂关系推理
5. **向量检索**: Milvus实现语义相似度匹配，提升威胁识别准确性
6. **私有化部署**: 全部组件支持私有化，满足汽车行业数据安全要求

该方案可根据实际业务规模和预算进行裁剪调整。
