# 汽车智能TARA分析系统 - MVP架构设计

## 一、系统概述

### 1.1 系统定位
面向汽车行业的智能威胁分析与风险评估（TARA）平台MVP版本，基于ISO/SAE 21434标准，结合AI智能体技术，实现汽车网络安全风险的自动化分析与评估。

### 1.2 MVP核心功能
| 模块 | 核心功能 |
|------|----------|
| 项目管理 | 项目创建、配置、版本管理 |
| 文档解析 | 文档上传、OCR识别、结构化提取 |
| 资产识别 | 资产发现、分类、关系构建 |
| 威胁风险分析 | 威胁识别、攻击路径、风险评估（合并模块） |
| 图表生成 | 攻击树、数据流图、风险矩阵 |
| 报告中心 | 报告生成、模板管理、导出 |

---

## 二、MVP整体架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                用户层                                        │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                     Web端 (Vue3 + TypeScript)                          │ │
│  │     项目管理 │ 文档解析 │ 资产管理 │ 威胁风险 │ 图表 │ 报告            │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                               网关层                                         │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                         Nginx Gateway                                  │ │
│  │                    反向代理 │ 负载均衡 │ 静态资源                       │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                             业务服务层                                       │
│                                                                              │
│   ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐          │
│   │  项目管理   │  │  文档解析   │  │  资产识别   │  │ 威胁风险分析 │          │
│   │  Service   │  │  Service   │  │  Service   │  │  Service   │          │
│   └────────────┘  └────────────┘  └────────────┘  └────────────┘          │
│                                                                              │
│   ┌────────────┐  ┌────────────┐                                           │
│   │  图表生成   │  │  报告中心   │                                           │
│   │  Service   │  │  Service   │                                           │
│   └────────────┘  └────────────┘                                           │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                             智能体层                                         │
│                                                                              │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                     MCP Agent Orchestrator                           │  │
│   │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐           │  │
│   │  │ 文档理解   │ │ 资产挖掘   │ │ 威胁风险   │ │ 报告撰写   │           │  │
│   │  │  Agent    │ │  Agent    │ │  Agent    │ │  Agent    │           │  │
│   │  └───────────┘ └───────────┘ └───────────┘ └───────────┘           │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                        MCP Servers                                   │  │
│   │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐  │  │
│   │  │Knowledge │ │ Database │ │ Document │ │Inference │ │  Report  │  │  │
│   │  │ Server   │ │  Server  │ │  Server  │ │  Server  │ │  Server  │  │  │
│   │  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘  │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              AI模型层                                        │
│                                                                              │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                      vLLM Inference Server                           │  │
│   │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌───────────────┐  │  │
│   │  │ Qwen3-VL-8B │ │    Qwen3    │ │   OCRFlux   │ │Qwen3-Embedding│  │  │
│   │  │  多模态理解  │ │   文本推理   │ │   OCR识别   │ │   向量嵌入    │  │  │
│   │  └─────────────┘ └─────────────┘ └─────────────┘ └───────────────┘  │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                               数据层                                         │
│                                                                              │
│   ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐    │
│   │  MySQL   │  │  Redis   │  │  Milvus  │  │  Neo4j   │  │  MinIO   │    │
│   │ 业务数据  │  │   缓存   │  │ 向量存储  │  │ 知识图谱  │  │ 文件存储  │    │
│   └──────────┘  └──────────┘  └──────────┘  └──────────┘  └──────────┘    │
│                                                                              │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                        ElasticSearch (全文检索)                       │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 三、前端架构 (Vue3)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          前端架构 (Vue3 + TypeScript)                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Views (页面)                                                                │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐         │
│  │ 项目管理  │ │ 文档解析  │ │ 资产管理  │ │威胁风险   │ │ 报告中心  │         │
│  │ Project  │ │ Document │ │  Asset   │ │ThreatRisk│ │  Report  │         │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘         │
│                                                                              │
│  Components (核心组件)                                                       │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐      │
│  │ 知识图谱可视化 │ │ 攻击树编辑器  │ │ 风险矩阵组件  │ │  AI对话组件  │      │
│  │  GraphView   │ │ AttackTree   │ │ RiskMatrix   │ │  AIChat     │      │
│  │   (D3.js)    │ │  (GoJS)      │ │ (ECharts)    │ │ (Stream)    │      │
│  └──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘      │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐                       │
│  │ 文档预览器    │ │ 数据流图     │ │ 表格组件     │                       │
│  │ DocViewer   │ │  DFDEditor  │ │  DataTable  │                       │
│  └──────────────┘ └──────────────┘ └──────────────┘                       │
│                                                                              │
├─────────────────────────────────────────────────────────────────────────────┤
│  Store: Pinia          │  Router: Vue Router 4      │  HTTP: Axios         │
├─────────────────────────────────────────────────────────────────────────────┤
│  UI: Element Plus + TailwindCSS                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 四、后端服务架构 (FastAPI)

### 4.1 服务划分

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          后端服务架构 (Python FastAPI)                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         tara-project-service                         │   │
│  │  项目管理服务                                                         │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │  • POST   /api/projects              创建项目                        │   │
│  │  • GET    /api/projects              项目列表                        │   │
│  │  • GET    /api/projects/{id}         项目详情                        │   │
│  │  • PUT    /api/projects/{id}         更新项目                        │   │
│  │  • DELETE /api/projects/{id}         删除项目                        │   │
│  │  • POST   /api/projects/{id}/clone   克隆项目                        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        tara-document-service                         │   │
│  │  文档解析服务                                                         │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │  • POST   /api/documents/upload      上传文档                        │   │
│  │  • POST   /api/documents/{id}/parse  解析文档 (OCR + 结构化)         │   │
│  │  • GET    /api/documents/{id}        文档详情                        │   │
│  │  • GET    /api/documents/{id}/content 提取内容                       │   │
│  │  • DELETE /api/documents/{id}        删除文档                        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         tara-asset-service                           │   │
│  │  资产识别服务                                                         │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │  • POST   /api/assets                创建资产                        │   │
│  │  • GET    /api/assets                资产列表                        │   │
│  │  • PUT    /api/assets/{id}           更新资产                        │   │
│  │  • DELETE /api/assets/{id}           删除资产                        │   │
│  │  • POST   /api/assets/discover       AI自动识别资产                  │   │
│  │  • GET    /api/assets/graph          资产关系图谱                    │   │
│  │  • POST   /api/assets/{id}/damage    添加损害场景                    │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      tara-threat-risk-service                        │   │
│  │  威胁风险分析服务 (合并模块)                                           │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │  威胁分析:                                                            │   │
│  │  • POST   /api/threats               创建威胁场景                    │   │
│  │  • GET    /api/threats               威胁列表                        │   │
│  │  • POST   /api/threats/analyze       AI威胁分析 (STRIDE)             │   │
│  │  • POST   /api/threats/{id}/attack-path  添加攻击路径                │   │
│  │  • GET    /api/threats/{id}/attack-tree  获取攻击树                  │   │
│  │                                                                       │   │
│  │  风险评估:                                                            │   │
│  │  • POST   /api/risks/assess          风险评估                        │   │
│  │  • GET    /api/risks                 风险列表                        │   │
│  │  • PUT    /api/risks/{id}            更新风险评估                    │   │
│  │  • GET    /api/risks/matrix          风险矩阵数据                    │   │
│  │  • POST   /api/risks/{id}/treatment  添加处置措施                    │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        tara-diagram-service                          │   │
│  │  图表生成服务                                                         │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │  • POST   /api/diagrams/attack-tree  生成攻击树图                    │   │
│  │  • POST   /api/diagrams/dfd          生成数据流图                    │   │
│  │  • POST   /api/diagrams/risk-matrix  生成风险矩阵                    │   │
│  │  • POST   /api/diagrams/architecture 生成架构图                      │   │
│  │  • GET    /api/diagrams/{id}/export  导出图表 (PNG/SVG/PDF)          │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        tara-report-service                           │   │
│  │  报告中心服务                                                         │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │  • GET    /api/reports/templates     报告模板列表                    │   │
│  │  • POST   /api/reports/generate      生成报告                        │   │
│  │  • GET    /api/reports               报告列表                        │   │
│  │  • GET    /api/reports/{id}          报告详情                        │   │
│  │  • GET    /api/reports/{id}/download 下载报告 (PDF/Word)             │   │
│  │  • DELETE /api/reports/{id}          删除报告                        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         tara-agent-service                           │   │
│  │  智能体服务                                                           │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │  • POST   /api/agent/chat            AI对话                          │   │
│  │  • POST   /api/agent/analyze         完整TARA分析                    │   │
│  │  • GET    /api/agent/tasks/{id}      任务状态查询                    │   │
│  │  • WS     /api/agent/stream          流式响应                        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 服务间通信

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              服务通信架构                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│                           ┌─────────────┐                                   │
│                           │   Nginx     │                                   │
│                           │  Gateway    │                                   │
│                           └──────┬──────┘                                   │
│                                  │                                          │
│            ┌─────────────────────┼─────────────────────┐                   │
│            │                     │                     │                   │
│            ▼                     ▼                     ▼                   │
│     ┌────────────┐       ┌────────────┐       ┌────────────┐              │
│     │  Project   │       │  Document  │       │   Asset    │              │
│     │  Service   │       │  Service   │       │  Service   │              │
│     └─────┬──────┘       └─────┬──────┘       └─────┬──────┘              │
│           │                    │                    │                      │
│           │              ┌─────┴─────┐              │                      │
│           │              ▼           ▼              │                      │
│           │       ┌────────────┐  ┌────────────┐    │                      │
│           │       │ThreatRisk  │  │  Diagram   │    │                      │
│           │       │  Service   │  │  Service   │    │                      │
│           │       └─────┬──────┘  └─────┬──────┘    │                      │
│           │             │               │           │                      │
│           └─────────────┼───────────────┼───────────┘                      │
│                         │               │                                  │
│                         ▼               ▼                                  │
│                   ┌────────────┐  ┌────────────┐                           │
│                   │  Report    │  │   Agent    │                           │
│                   │  Service   │  │  Service   │                           │
│                   └────────────┘  └────────────┘                           │
│                                                                              │
│  通信方式:                                                                   │
│  ────────  HTTP/REST (同步)                                                 │
│  - - - -   Redis Pub/Sub (异步事件)                                         │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 五、智能体架构

### 5.1 MCP Agent 架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           MCP智能体架构                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      Agent Orchestrator (编排器)                      │   │
│  │                                                                       │   │
│  │   ┌─────────────────────────────────────────────────────────────┐   │   │
│  │   │ Task Planner │ 任务分解 → 依赖分析 → 调度执行 → 结果聚合       │   │   │
│  │   └─────────────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                      │                                      │
│          ┌───────────────────────────┼───────────────────────────┐         │
│          │                           │                           │         │
│          ▼                           ▼                           ▼         │
│  ┌──────────────┐          ┌──────────────┐          ┌──────────────┐     │
│  │  文档理解     │          │  资产挖掘     │          │  威胁风险     │     │
│  │   Agent      │          │   Agent      │          │   Agent      │     │
│  │              │          │              │          │              │     │
│  │ ┌──────────┐ │          │ ┌──────────┐ │          │ ┌──────────┐ │     │
│  │ │Qwen3-VL  │ │          │ │  Qwen3   │ │          │ │  Qwen3   │ │     │
│  │ │+OCRFlux  │ │          │ │ +Neo4j   │ │          │ │+规则引擎  │ │     │
│  │ └──────────┘ │          │ └──────────┘ │          │ └──────────┘ │     │
│  │              │          │              │          │              │     │
│  │ 能力:        │          │ 能力:        │          │ 能力:        │     │
│  │ • 文档OCR    │          │ • 实体抽取   │          │ • STRIDE分析 │     │
│  │ • 版面分析   │          │ • 资产分类   │          │ • 攻击路径   │     │
│  │ • 内容提取   │          │ • 关系识别   │          │ • 风险计算   │     │
│  │ • 表格识别   │          │ • 图谱构建   │          │ • 处置建议   │     │
│  └──────────────┘          └──────────────┘          └──────────────┘     │
│                                      │                                      │
│                                      ▼                                      │
│                            ┌──────────────┐                                │
│                            │  报告撰写     │                                │
│                            │   Agent      │                                │
│                            │              │                                │
│                            │ ┌──────────┐ │                                │
│                            │ │  Qwen3   │ │                                │
│                            │ │+模板引擎  │ │                                │
│                            │ └──────────┘ │                                │
│                            │              │                                │
│                            │ 能力:        │                                │
│                            │ • 内容撰写   │                                │
│                            │ • 图表生成   │                                │
│                            │ • PDF导出   │                                │
│                            └──────────────┘                                │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 MCP Servers

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            MCP Servers                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐             │
│  │ Knowledge Server│  │ Database Server │  │ Document Server │             │
│  ├─────────────────┤  ├─────────────────┤  ├─────────────────┤             │
│  │ Tools:          │  │ Tools:          │  │ Tools:          │             │
│  │ • query_graph   │  │ • execute_sql   │  │ • read_document │             │
│  │ • find_threats  │  │ • insert_data   │  │ • extract_text  │             │
│  │ • get_relations │  │ • update_data   │  │ • parse_table   │             │
│  │                 │  │                 │  │ • convert_format│             │
│  │ Resources:      │  │ Resources:      │  │                 │             │
│  │ • threat_library│  │ • schema_info   │  │ Resources:      │             │
│  │ • control_lib   │  │                 │  │ • doc_templates │             │
│  │                 │  │ 连接: MySQL     │  │                 │             │
│  │ 连接: Neo4j     │  │                 │  │ 连接: MinIO     │             │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘             │
│                                                                              │
│  ┌─────────────────┐  ┌─────────────────┐                                  │
│  │ Inference Server│  │  Report Server  │                                  │
│  ├─────────────────┤  ├─────────────────┤                                  │
│  │ Tools:          │  │ Tools:          │                                  │
│  │ • call_llm      │  │ • render_report │                                  │
│  │ • embed_text    │  │ • generate_chart│                                  │
│  │ • search_vector │  │ • export_pdf    │                                  │
│  │ • call_ocr      │  │ • export_docx   │                                  │
│  │                 │  │                 │                                  │
│  │ Resources:      │  │ Resources:      │                                  │
│  │ • model_info    │  │ • report_tpl    │                                  │
│  │                 │  │ • chart_tpl     │                                  │
│  │ 连接: vLLM      │  │                 │                                  │
│  │       Milvus    │  │ 连接: MinIO     │                                  │
│  └─────────────────┘  └─────────────────┘                                  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 六、TARA分析工作流

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          TARA分析工作流 (4阶段)                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │ Phase 1: 文档解析                                                      │ │
│  │                                                                         │ │
│  │  ┌────────┐    ┌────────┐    ┌────────┐    ┌────────┐    ┌────────┐  │ │
│  │  │文档上传 │───▶│OCR识别 │───▶│版面分析│───▶│内容提取│───▶│结构存储 │  │ │
│  │  │ MinIO  │    │OCRFlux │    │Qwen3-VL│    │ Qwen3  │    │ES+MySQL│  │ │
│  │  └────────┘    └────────┘    └────────┘    └────────┘    └────────┘  │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                      │                                      │
│                                      ▼                                      │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │ Phase 2: 资产识别                                                      │ │
│  │                                                                         │ │
│  │  ┌────────┐    ┌────────┐    ┌────────┐    ┌────────┐               │ │
│  │  │实体抽取│───▶│资产分类│───▶│关系识别│───▶│图谱构建│               │ │
│  │  │ Qwen3  │    │ 分类器 │    │ Qwen3  │    │ Neo4j  │               │ │
│  │  └────────┘    └────────┘    └────────┘    └────────┘               │ │
│  │                                                                         │ │
│  │  输出: 资产清单、资产关系图谱、损害场景                                  │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                      │                                      │
│                                      ▼                                      │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │ Phase 3: 威胁风险分析 (合并阶段)                                        │ │
│  │                                                                         │ │
│  │  威胁分析                           风险评估                            │ │
│  │  ┌────────┐    ┌────────┐         ┌────────┐    ┌────────┐          │ │
│  │  │STRIDE  │───▶│攻击路径│────────▶│攻击可行│───▶│风险计算│          │ │
│  │  │分析    │    │构建    │         │性评估  │    │R=I×L  │          │ │
│  │  └────────┘    └────────┘         └────────┘    └────────┘          │ │
│  │       │                                              │               │ │
│  │       ▼                                              ▼               │ │
│  │  ┌────────┐                                    ┌────────┐          │ │
│  │  │攻击树  │                                    │处置建议│          │ │
│  │  │生成    │                                    │生成    │          │ │
│  │  └────────┘                                    └────────┘          │ │
│  │                                                                         │ │
│  │  Attack Potential = 专业知识(0-8) + 时间(0-19) + 设备(0-10) + 信息(0-7) │ │
│  │  Impact = max(Safety, Financial, Operational, Privacy)                 │ │
│  │  Risk = Impact × Likelihood                                            │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                      │                                      │
│                                      ▼                                      │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │ Phase 4: 报告生成                                                      │ │
│  │                                                                         │ │
│  │  ┌────────┐    ┌────────┐    ┌────────┐    ┌────────┐               │ │
│  │  │数据聚合│───▶│内容撰写│───▶│图表插入│───▶│PDF导出 │               │ │
│  │  │        │    │ Qwen3  │    │        │    │        │               │ │
│  │  └────────┘    └────────┘    └────────┘    └────────┘               │ │
│  │                                                                         │ │
│  │  输出: ISO 21434 TARA报告 (PDF/Word)                                   │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 七、数据架构

### 7.1 数据存储职责

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              数据存储架构                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                         MySQL (业务主数据)                            │  │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐       │  │
│  │  │ project │ │  asset  │ │ threat  │ │  risk   │ │ report  │       │  │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘       │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                         Neo4j (知识图谱)                              │  │
│  │                                                                        │  │
│  │   (Asset)──[:CONNECTS_TO]──▶(Asset)                                   │  │
│  │      │                                                                 │  │
│  │      └──[:HAS_THREAT]──▶(Threat)──[:EXPLOITS]──▶(Vulnerability)       │  │
│  │                            │                                          │  │
│  │                            └──[:MITIGATED_BY]──▶(Control)             │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                      Milvus (向量检索)                                │  │
│  │  • doc_embeddings    文档语义向量                                     │  │
│  │  • threat_embeddings 威胁库向量 (相似威胁匹配)                         │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                    ElasticSearch (全文检索)                           │  │
│  │  • tara_documents    文档全文索引                                     │  │
│  │  • tara_threats      威胁库检索                                       │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                        Redis (缓存)                                   │  │
│  │  • 会话缓存  • 热点数据  • 任务队列  • 分布式锁                        │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                       MinIO (文件存储)                                │  │
│  │  • documents/   原始文档                                              │  │
│  │  • reports/     生成的报告                                            │  │
│  │  • diagrams/    图表文件                                              │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 7.2 核心数据模型

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              核心ER模型                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   PROJECT ─────────┬──────────────┬───────────────┬──────────────           │
│      │             │              │               │                          │
│      │ 1:N         │ 1:N          │ 1:N           │ 1:N                      │
│      ▼             ▼              ▼               ▼                          │
│   DOCUMENT       ASSET      THREAT_RISK        REPORT                       │
│      │             │              │                                          │
│      │             │ 1:N          │ 1:N                                      │
│      │             ▼              ▼                                          │
│      │      DAMAGE_SCENARIO  ATTACK_PATH                                    │
│      │                           │                                          │
│      │                           │ 1:1                                      │
│      │                           ▼                                          │
│      │                    RISK_ASSESSMENT                                   │
│      │                           │                                          │
│      │                           │ N:M                                      │
│      │                           ▼                                          │
│      └───────────────────▶ CONTROL_MEASURE                                  │
│                                                                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  PROJECT                        │  ASSET                                    │
│  ─────────────────────────────  │  ─────────────────────────────            │
│  id            BIGINT PK        │  id              BIGINT PK                │
│  name          VARCHAR(200)     │  project_id      BIGINT FK                │
│  vehicle_type  VARCHAR(50)      │  name            VARCHAR(200)             │
│  standard      VARCHAR(50)      │  type            VARCHAR(50)              │
│  status        TINYINT          │  category        VARCHAR(50)              │
│  created_at    DATETIME         │  security_attrs  JSON                     │
│                                 │  interfaces      JSON                     │
│                                 │  parent_id       BIGINT FK                │
│                                                                              │
│  THREAT_RISK (合并表)            │  ATTACK_PATH                              │
│  ─────────────────────────────  │  ─────────────────────────────            │
│  id            BIGINT PK        │  id              BIGINT PK                │
│  project_id    BIGINT FK        │  threat_id       BIGINT FK                │
│  asset_id      BIGINT FK        │  name            VARCHAR(200)             │
│  damage_desc   TEXT             │  steps           JSON                     │
│  threat_type   VARCHAR(20)      │  expertise       TINYINT                  │
│  threat_desc   TEXT             │  elapsed_time    TINYINT                  │
│  attack_vector TEXT             │  equipment       TINYINT                  │
│  impact_s/f/o/p TINYINT         │  knowledge       TINYINT                  │
│  likelihood    TINYINT          │  attack_potential TINYINT                 │
│  risk_value    TINYINT          │  risk_level      VARCHAR(20)              │
│  risk_level    VARCHAR(20)      │  treatment       VARCHAR(50)              │
│  treatment     VARCHAR(50)      │                                           │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 八、MVP部署架构

### 8.1 Docker Compose 部署 (开发/测试)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       Docker Compose 部署架构                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                         docker-compose.yml                           │  │
│   │                                                                       │  │
│   │  services:                                                            │  │
│   │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐       │  │
│   │  │  nginx  │ │frontend │ │ project │ │document │ │  asset  │       │  │
│   │  │  :80    │ │  :3000  │ │  :8001  │ │  :8002  │ │  :8003  │       │  │
│   │  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘       │  │
│   │                                                                       │  │
│   │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐                    │  │
│   │  │threat-  │ │ diagram │ │ report  │ │  agent  │                    │  │
│   │  │risk:8004│ │  :8005  │ │  :8006  │ │  :8007  │                    │  │
│   │  └─────────┘ └─────────┘ └─────────┘ └─────────┘                    │  │
│   │                                                                       │  │
│   │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐       │  │
│   │  │  mysql  │ │  redis  │ │  neo4j  │ │ milvus  │ │  minio  │       │  │
│   │  │  :3306  │ │  :6379  │ │  :7687  │ │ :19530  │ │  :9000  │       │  │
│   │  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘       │  │
│   │                                                                       │  │
│   │  ┌────────────────────┐                                              │  │
│   │  │   elasticsearch    │                                              │  │
│   │  │       :9200        │                                              │  │
│   │  └────────────────────┘                                              │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                    docker-compose.gpu.yml (AI模型)                    │  │
│   │                                                                       │  │
│   │  services:                                                            │  │
│   │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐   │  │
│   │  │ vllm-qwen3  │ │ vllm-qwen3  │ │   ocrflux   │ │  embedding  │   │  │
│   │  │    -vl      │ │             │ │             │ │             │   │  │
│   │  │  GPU: A100  │ │  GPU: A100  │ │  GPU: A10   │ │  GPU: T4    │   │  │
│   │  │    :8100    │ │    :8101    │ │    :8102    │ │    :8103    │   │  │
│   │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘   │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 8.2 生产环境部署 (K8s简化版)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         K8s MVP 部署架构                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                       Ingress (Nginx)                                │   │
│  │                      tara.example.com                                │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                      │                                      │
│                    ┌─────────────────┼─────────────────┐                   │
│                    │                 │                 │                   │
│                    ▼                 ▼                 ▼                   │
│  Namespace: tara-app                                                        │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐       │  │
│  │  │frontend │ │project- │ │document-│ │ asset-  │ │threat-  │       │  │
│  │  │ Deploy  │ │svc Dep  │ │svc Dep  │ │svc Dep  │ │risk Dep │       │  │
│  │  │ rep: 2  │ │ rep: 2  │ │ rep: 2  │ │ rep: 2  │ │ rep: 2  │       │  │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘       │  │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐                               │  │
│  │  │diagram- │ │report-  │ │ agent-  │                               │  │
│  │  │svc Dep  │ │svc Dep  │ │svc Dep  │                               │  │
│  │  │ rep: 2  │ │ rep: 2  │ │ rep: 2  │                               │  │
│  │  └─────────┘ └─────────┘ └─────────┘                               │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  Namespace: tara-model                                                      │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐   │  │
│  │  │ vllm-qwen3  │ │ vllm-qwen3  │ │   ocrflux   │ │  embedding  │   │  │
│  │  │ -vl Deploy  │ │   Deploy    │ │   Deploy    │ │   Deploy    │   │  │
│  │  │ GPU: 1xA100 │ │ GPU: 1xA100 │ │ GPU: 1xA10  │ │ GPU: 1xT4   │   │  │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘   │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  Namespace: tara-data                                                       │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐       │  │
│  │  │  mysql  │ │  redis  │ │  neo4j  │ │ milvus  │ │  minio  │       │  │
│  │  │StatefulS│ │StatefulS│ │StatefulS│ │StatefulS│ │StatefulS│       │  │
│  │  │ rep: 1  │ │ rep: 1  │ │ rep: 1  │ │ rep: 1  │ │ rep: 1  │       │  │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘       │  │
│  │  ┌────────────────────┐                                             │  │
│  │  │   elasticsearch    │                                             │  │
│  │  │    StatefulSet     │                                             │  │
│  │  │      rep: 1        │                                             │  │
│  │  └────────────────────┘                                             │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 8.3 MVP硬件配置

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          MVP硬件配置 (最小化)                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  开发环境 (单机)                                                             │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │  • CPU: 32核                                                          │  │
│  │  • 内存: 128GB                                                        │  │
│  │  • GPU: 1x NVIDIA A100 80GB (或 2x A10 24GB)                          │  │
│  │  • 存储: 2TB NVMe SSD                                                 │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  生产环境 (最小配置)                                                         │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                                                                        │  │
│  │  GPU服务器 × 1                      │  应用服务器 × 2                  │  │
│  │  ────────────────────               │  ────────────────────            │  │
│  │  • CPU: 64核                        │  • CPU: 32核                     │  │
│  │  • 内存: 256GB                      │  • 内存: 64GB                    │  │
│  │  • GPU: 2x A100 80GB                │  • 存储: 500GB SSD               │  │
│  │  • 存储: 1TB NVMe                   │                                  │  │
│  │                                                                        │  │
│  │  数据库服务器 × 1                    │  存储服务器 × 1                  │  │
│  │  ────────────────────               │  ────────────────────            │  │
│  │  • CPU: 32核                        │  • CPU: 16核                     │  │
│  │  • 内存: 128GB                      │  • 内存: 32GB                    │  │
│  │  • 存储: 2TB NVMe SSD               │  • 存储: 10TB HDD                │  │
│  │                                                                        │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  资源汇总 (生产MVP)                                                          │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │  • 服务器: 5台                                                        │  │
│  │  • CPU: ~176核                                                        │  │
│  │  • 内存: ~544GB                                                       │  │
│  │  • GPU显存: 160GB (2x A100 80GB)                                      │  │
│  │  • 存储: ~14TB                                                        │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 九、技术栈汇总

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              MVP技术栈                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  前端                                                                        │
│  ────────────────────────────────────────────────────────                   │
│  • 框架: Vue 3 + TypeScript                                                 │
│  • 状态管理: Pinia                                                          │
│  • UI组件: Element Plus + TailwindCSS                                       │
│  • 图表: ECharts + D3.js                                                    │
│  • 流程图: GoJS / LogicFlow                                                 │
│  • HTTP: Axios                                                              │
│  • 构建: Vite                                                               │
│                                                                              │
│  后端                                                                        │
│  ────────────────────────────────────────────────────────                   │
│  • 框架: Python FastAPI                                                     │
│  • ORM: SQLAlchemy                                                          │
│  • 任务队列: Celery + Redis                                                 │
│  • 文档生成: python-docx, reportlab                                         │
│  • 图表生成: matplotlib, graphviz                                           │
│                                                                              │
│  智能体                                                                      │
│  ────────────────────────────────────────────────────────                   │
│  • 协议: MCP (Model Context Protocol)                                       │
│  • Agent框架: LangChain / 自研                                              │
│  • 向量检索: LangChain + Milvus                                             │
│                                                                              │
│  AI模型                                                                      │
│  ────────────────────────────────────────────────────────                   │
│  • 推理框架: vLLM                                                           │
│  • 多模态: Qwen3-VL-8B                                                      │
│  • 语言模型: Qwen3                                                          │
│  • OCR: OCRFlux                                                             │
│  • 嵌入: Qwen3-Embedding-0.6B                                               │
│                                                                              │
│  数据存储                                                                    │
│  ────────────────────────────────────────────────────────                   │
│  • 关系数据库: MySQL 8.0                                                    │
│  • 缓存: Redis 7                                                            │
│  • 图数据库: Neo4j 5                                                        │
│  • 向量数据库: Milvus 2.3                                                   │
│  • 搜索引擎: ElasticSearch 8                                                │
│  • 对象存储: MinIO                                                          │
│                                                                              │
│  基础设施                                                                    │
│  ────────────────────────────────────────────────────────                   │
│  • 容器: Docker                                                             │
│  • 编排: Docker Compose / Kubernetes                                        │
│  • 网关: Nginx                                                              │
│  • 监控: Prometheus + Grafana (可选)                                        │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 十、MVP开发计划

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           MVP开发计划 (16周)                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Phase 1: 基础搭建 (Week 1-3)                                               │
│  ├── 开发环境搭建                                                            │
│  ├── Docker Compose 编排                                                    │
│  ├── 数据库初始化 (MySQL/Neo4j/Milvus/ES/Redis/MinIO)                       │
│  ├── AI模型部署 (vLLM)                                                      │
│  └── 前后端项目初始化                                                        │
│                                                                              │
│  Phase 2: 核心服务开发 (Week 4-8)                                            │
│  ├── 项目管理服务                                                            │
│  ├── 文档解析服务 (OCR + 多模态)                                            │
│  ├── 资产识别服务                                                            │
│  ├── 威胁风险分析服务                                                        │
│  └── MCP Server 开发 (5个)                                                  │
│                                                                              │
│  Phase 3: 智能体开发 (Week 9-11)                                             │
│  ├── Agent Orchestrator                                                     │
│  ├── 文档理解 Agent                                                         │
│  ├── 资产挖掘 Agent                                                         │
│  ├── 威胁风险 Agent                                                         │
│  └── 报告撰写 Agent                                                         │
│                                                                              │
│  Phase 4: 前端与报告 (Week 12-14)                                            │
│  ├── 前端页面开发 (6个核心页面)                                              │
│  ├── 图表生成服务                                                            │
│  ├── 报告中心服务                                                            │
│  └── AI对话组件                                                              │
│                                                                              │
│  Phase 5: 集成测试 (Week 15-16)                                              │
│  ├── 端到端测试                                                              │
│  ├── 性能优化                                                                │
│  ├── Bug修复                                                                 │
│  └── 文档编写                                                                │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 十一、MVP核心交付物

| 交付物 | 说明 |
|--------|------|
| Web前端 | Vue3单页应用，6个核心功能模块 |
| 后端服务 | 7个FastAPI微服务 |
| 智能体系统 | 4个专业Agent + 5个MCP Server |
| AI模型服务 | vLLM部署的4个模型 |
| 数据库 | MySQL/Neo4j/Milvus/ES/Redis/MinIO |
| 部署脚本 | Docker Compose + K8s配置 |
| API文档 | OpenAPI/Swagger文档 |
| 用户手册 | 系统使用说明 |
